// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

// User model for authentication
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  role          String    @default("user") // "user" or "admin"
  avatar        String?
  bio           String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  testAttempts  TestAttempt[]
  results       Result[]
  achievements  Achievement[]
  dailyPlanTasks DailyPlanTask[]
  reviewPlanItems ReviewPlanItem[]
  reviewCompletions ReviewCompletion[]
  dailyReportSetting DailyReportSetting?
  dailyReportLogs DailyReportLog[]

  @@map("users")
}

model DailyPlanTask {
  id        String   @id @default(cuid())
  userId    String
  date      String   // YYYY-MM-DD
  title     String
  note      String?
  done      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@map("daily_plan_tasks")
}

model ReviewPlanItem {
  id         String   @id @default(cuid())
  userId     String
  subject    String
  topic      String
  studiedDate String  // YYYY-MM-DD
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  completions ReviewCompletion[]

  @@index([userId, studiedDate])
  @@map("review_plan_items")
}

model ReviewCompletion {
  id            String   @id @default(cuid())
  userId        String
  reviewPlanItemId String
  reviewDate    String   // YYYY-MM-DD
  intervalDays  Int
  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewPlanItem ReviewPlanItem @relation(fields: [reviewPlanItemId], references: [id], onDelete: Cascade)

  @@unique([userId, reviewPlanItemId, reviewDate, intervalDays])
  @@index([userId, reviewDate])
  @@map("review_completions")
}

model DailyReportSetting {
  id           String   @id @default(cuid())
  userId       String   @unique
  targetEmail  String
  enabled      Boolean  @default(false)
  sendHour     Int      @default(20)
  timeZone     String   @default("Europe/Kyiv")
  lastSentDate String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("daily_report_settings")
}

model DailyReportLog {
  id          String   @id @default(cuid())
  userId      String
  targetEmail String
  reportDate  String
  status      String
  errorMessage String?
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, reportDate])
  @@map("daily_report_logs")
}

// Subject model (Ukrainian Language, Mathematics, etc.)
model Subject {
  id        String   @id @default(cuid())
  name      String   @unique // "Ukrainian Language", "Mathematics", etc.
  slug      String   @unique
  icon      String?
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tests     Test[]
  topics    Topic[]

  @@map("subjects")
}

// Topic model (for topic-based tests)
model Topic {
  id        String   @id @default(cuid())
  subjectId String
  name      String   // "Phonetics", "Algebra", etc.
  slug      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  // Relations
  tests     Test[]

  @@unique([subjectId, slug])
  @@map("topics")
}

// Test model
model Test {
  id          String   @id @default(cuid())
  subjectId   String
  topicId     String?
  title       String
  description String?
  type        String   // "topic" or "past_nmt"
  historyTopicCode String?
  mathTrack   String?  // "algebra" or "geometry"
  year        Int?     // For past NMT tests
  image       String?
  estimatedTime Int   @default(60) // In minutes
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subject     Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  topic       Topic?   @relation(fields: [topicId], references: [id], onDelete: SetNull)

  // Relations
  questions   Question[]
  attempts    TestAttempt[]

  @@map("tests")
}

// Question model
model Question {
  id          String   @id @default(cuid())
  testId      String
  type        String   // "single_choice", "matching", "written", "multiple_answers"
  content     String   // The question text
  imageUrl    String?
  order       Int      // Order in test
  points      Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  test        Test     @relation(fields: [testId], references: [id], onDelete: Cascade)

  // Relations
  answers     Answer[]

  @@map("questions")
}

// Answer model
model Answer {
  id          String   @id @default(cuid())
  questionId  String
  type        String   // "single_choice", "multiple", "text"
  content     String   // The answer text/option
  isCorrect   Boolean  @default(false)
  order       Int?     // For matching pairs or multiple choice
  matchingPair String? // For matching type questions (ID of paired answer)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("answers")
}

// TestAttempt model (tracks when user takes a test)
model TestAttempt {
  id          String   @id @default(cuid())
  userId      String
  testId      String
  startedAt   DateTime @default(now())
  pausedAt    DateTime?
  resumedAt   DateTime?
  completedAt DateTime?
  status      String   @default("in_progress") // "in_progress", "paused", "completed"
  totalTime   Int      @default(0) // In seconds
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  test        Test     @relation(fields: [testId], references: [id], onDelete: Cascade)

  // Relations
  userAnswers UserAnswer[]
  result      Result?

  @@map("test_attempts")
}

// UserAnswer model (tracks user's answer to each question)
model UserAnswer {
  id          String   @id @default(cuid())
  attemptId   String
  questionId  String
  answerIds   String   // JSON stringified array of answer IDs (SQLite-safe)
  answerText  String?  // For written answers
  isCorrect   Boolean?
  partialCredit Boolean @default(false)
  score       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  attempt     TestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@map("user_answers")
}

// Result model (final test result)
model Result {
  id          String   @id @default(cuid())
  userId      String
  attemptId   String   @unique
  testId      String?
  correctAnswers Int
  totalQuestions Int
  rawScore    Int      // 0-100
  scaledScore Int      // 0-200 (official NMT scale)
  percentage  Float
  timeSpent   Int      // In seconds
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  attempt     TestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@map("results")
}

// Achievement model (badges/achievements)
model Achievement {
  id          String   @id @default(cuid())
  userId      String
  type        String   // "first_test", "perfect_score", "streak_7", etc.
  name        String
  description String?
  icon        String?
  unlockedAt  DateTime @default(now())
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("achievements")
}

// Leaderboard entry (aggregated stats per user)
model UserStats {
  id          String   @id @default(cuid())
  userId      String   @unique
  totalTests  Int      @default(0)
  totalScore  Int      @default(0)
  averageScore Float   @default(0)
  bestScore   Int      @default(0)
  accuracy    Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("user_stats")
}
